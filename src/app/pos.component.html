<main class="pos-main">
  <!-- Cart/Checkout Section -->
  <div class="pos-cart">
    <div style="background:#fff;border-radius:1.5rem;box-shadow:0 4px 24px 0 #0001;padding:2.5rem 2rem 2rem 2rem;border:1px solid #e0e0e0;">
      <div style="font-size:2.1rem;font-weight:700;color:#7b2ff2;margin-bottom:1.2rem;letter-spacing:-1px;text-align:center;">Mall POS</div>
      <div style="margin-bottom:1.2rem; display: flex; flex-direction: column; align-items: center;">
        <label 
          style="font-size:1rem;color:#888;font-weight:500; margin-bottom: 0.5rem; text-align: center; width: 100%;"
          for="customerName"
        >
          Customer Name (optional)
        </label>
        <input
          style="padding:0.7rem 1rem;border-radius:0.7rem;border:1px solid #e0e0e0;font-size:1.1rem;outline:none;width:80%;max-width:320px;text-align:center;"
          id="customerName"
          type="text"
          [(ngModel)]="customerName"
          placeholder="Enter customer name"
        />
      </div>
      
      <!-- Cart Items -->
      <div style="margin:1.5rem 0 1rem 0;border-radius:1rem;background:#fafaff;border:1px solid #e0e0e0;padding:1rem 0.5rem;min-height:60px;">
        <div *ngIf="cart.length === 0" style="color:#888;text-align:center;">No products added.</div>
        <div *ngFor="let item of cart; let i = index" style="display:flex;align-items:center;justify-content:space-between;padding:0.7rem 0.5rem;border-bottom:1px solid #f0f0f0;gap:0.5rem;">
          <div style="flex:1 1 0;font-weight:500;color:#333;">{{ item.name }}</div>
          
          <!-- Quantity Controls -->
          <div style="display:flex;align-items:center;gap:0.3rem;">
            <button style="background:#7b2ff2;color:#fff;border:none;border-radius:50%;width:2rem;height:2rem;font-size:1.2rem;cursor:pointer;" (click)="decrement(i)">-</button>
            <span style="min-width:2rem;text-align:center;font-size:1.1rem;font-weight:600;color:#7b2ff2;">{{ item.quantity }}</span>
            <button style="background:#7b2ff2;color:#fff;border:none;border-radius:50%;width:2rem;height:2rem;font-size:1.2rem;cursor:pointer;" (click)="increment(i)">+</button>
            <button style="background:#fff0f3;color:#f357a8;border:none;border-radius:50%;width:1.7rem;height:1.7rem;font-size:1rem;cursor:pointer;margin-left:0.5rem;" (click)="remove(i)" title="Remove">&times;</button>
          </div>
          
          <!-- Price Display/Edit -->
          <div style="min-width:80px;text-align:right;">
            <div *ngIf="editingPriceIndex !== i" style="display:flex;align-items:center;justify-content:flex-end;gap:0.3rem;">
              <span style="color:#888;font-size:0.9rem;">Rs {{ item.price }}</span>
              <button 
                style="background:none;border:none;color:#7b2ff2;cursor:pointer;font-size:0.8rem;padding:2px 4px;"
                (click)="startEditingPrice(i)"
                title="Edit price"
              >‚úèÔ∏è</button>
            </div>
            <div *ngIf="editingPriceIndex === i" style="display:flex;align-items:center;gap:0.2rem;">
              <input 
                type="number" 
                [(ngModel)]="tempPrice"
                style="width:60px;padding:2px 4px;border:1px solid #ddd;border-radius:3px;font-size:0.9rem;"
                min="0.01"
                step="0.01"
                (keyup.enter)="savePrice(i)"
                (keyup.escape)="cancelEditPrice()"
              />
              <button 
                style="background:#4caf50;color:#fff;border:none;border-radius:3px;padding:2px 4px;font-size:0.8rem;cursor:pointer;"
                (click)="savePrice(i)"
              >‚úì</button>
              <button 
                style="background:#f44336;color:#fff;border:none;border-radius:3px;padding:2px 4px;font-size:0.8rem;cursor:pointer;"
                (click)="cancelEditPrice()"
              >‚úó</button>
            </div>
            <div style="color:#333;font-weight:600;font-size:0.95rem;margin-top:2px;">
              Rs {{ item.price * item.quantity }}
            </div>
          </div>
        </div>
      </div>

      <!-- Subtotal and Discount Section -->
      <div style="margin:1rem 0;padding:1rem;background:#f8f9ff;border-radius:0.8rem;border:1px solid #e8e9f3;">
        <!-- Subtotal -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.8rem;">
          <span style="font-size:1rem;color:#666;font-weight:500;">Subtotal:</span>
          <span style="font-size:1.2rem;font-weight:600;color:#333;">Rs {{ getSubtotal() }}</span>
        </div>

        <!-- Discount Section -->
        <div style="border-top:1px solid #e0e0e0;padding-top:0.8rem;">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
            <label style="font-size:0.95rem;color:#666;font-weight:500;min-width:60px;">Discount:</label>
            <select 
              [(ngModel)]="discountType" 
              (change)="updateReturnAmount()"
              style="padding:0.3rem;border:1px solid #ddd;border-radius:4px;font-size:0.9rem;"
            >
              <option value="amount">Amount (Rs)</option>
              <option value="percentage">Percentage (%)</option>
            </select>
            <input 
              type="number" 
              [(ngModel)]="discountAmount"
              (input)="updateReturnAmount()"
              placeholder="0"
              min="0"
              [max]="discountType === 'percentage' ? 100 : getSubtotal()"
              style="width:80px;padding:0.3rem;border:1px solid #ddd;border-radius:4px;font-size:0.9rem;"
            />
            <button 
              style="background:#ff6b6b;color:#fff;border:none;border-radius:4px;padding:0.3rem 0.6rem;font-size:0.8rem;cursor:pointer;"
              (click)="resetDiscount()"
              title="Reset discount"
            >Reset</button>
          </div>
          
          <div *ngIf="getDiscountAmount() > 0" style="display:flex;justify-content:space-between;align-items:center;color:#f357a8;font-size:0.95rem;">
            <span>Discount Applied:</span>
            <span>- Rs {{ getDiscountAmount() }}</span>
          </div>
        </div>
      </div>

      <!-- Total -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding:0.8rem;background:#f0fff4;border-radius:0.8rem;border:1px solid #c8e6c9;">
        <span style="font-size:1.2rem;color:#2e7d32;font-weight:600;">Total:</span>
        <span style="font-size:1.6rem;font-weight:700;color:#2e7d32;">Rs {{ getCartTotal() }}</span>
      </div>

      <!-- Cash Paid -->
      <div style="margin:1rem 0; display: flex; flex-direction: column; align-items: center;">
        <label 
          style="font-size:1rem;color:#888;font-weight:500; margin-bottom: 0.5rem; text-align: center; width: 100%;"
          for="cashPaid"
        >
          Cash Paid
        </label>
        <input
          id="cashPaid"
          type="number"
          min="0"
          [(ngModel)]="cashPaid"
          placeholder="Enter cash paid"
          (input)="updateReturnAmount()"
          style="padding:0.7rem 1rem;border-radius:0.7rem;border:1px solid #e0e0e0;font-size:1.1rem;outline:none;width:80%;max-width:320px;text-align:center;"
          inputmode="numeric"
          onwheel="this.blur()" 
        />
      </div>

      <!-- Return Amount -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;" *ngIf="cashPaid > 0">
        <div>
          <span style="font-size:1.1rem;color:#888;font-weight:500;">Return to Customer:</span>
          <span
            style="font-size:1.5rem;font-weight:700;color:#f357a8;"
          >
            Rs {{ returnAmount >= 0 ? returnAmount : 0 }}
          </span>
          <span *ngIf="returnAmount < 0" style="color:#f357a8;font-size:0.95em;">
            (Insufficient cash)
          </span>
        </div>
      </div>

      <!-- Checkout Button -->
      <div style="display:flex;justify-content:flex-end;">
        <button
          class="checkout-btn"
          [disabled]="cart.length === 0 || returnAmount < 0 || isCheckingOut"
          (click)="checkout()"   
        >
          <span>
            <svg width="22" height="22" fill="none" viewBox="0 0 24 24"><path fill="#fff" d="M7 18c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v9c0 1.1-.9 2-2 2H7zm0 2h10c2.21 0 4-1.79 4-4V7c0-2.21-1.79-4-4-4H7C4.79 3 3 4.79 3 7v9c0 2.21 1.79 4 4 4z"/></svg>
            {{ isCheckingOut ? 'Processing...' : 'Checkout' }}
          </span>
        </button>
      </div>
    </div>
  </div>

  <!-- Product List Section -->
  <div class="pos-products">
    <input
      style="padding:0.7rem 1rem;border-radius:0.7rem;border:1px solid #e0e0e0;font-size:1.1rem;outline:none;width:100%;margin-bottom:0.7rem;"
      type="text"
      [(ngModel)]="productSearch"
      (input)="onProductSearch()"
      placeholder="Search products..."
      autocomplete="off"
    />
    <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:1.2rem;">
      <div
        style="background:#f7f7fa;border-radius:1rem;border:1px solid #e0e0e0;padding:1rem 0.5rem 0.7rem 0.5rem;display:flex;flex-direction:column;align-items:center;position:relative;box-shadow:0 2px 8px #7b2ff211;"
        *ngFor="let prod of pagedProducts"
        [class.out-of-stock]="prod.stock === 0"
        [ngStyle]="{ cursor: prod.stock > 0 ? 'pointer' : 'not-allowed', opacity: prod.stock > 0 ? 1 : 0.6 }"
        (click)="prod.stock > 0 && addToCart(prod)"
      >
        <button (click)="$event.stopPropagation(); openStockMenu(prod)" style="position:absolute;top:0.4rem;right:0.4rem;background:none;border:none;cursor:pointer;font-size:1.5rem;line-height:1;color:#888;z-index:2;">
          &#8942;
        </button>
        <span style="font-size:2.5rem;color:#7b2ff2;margin-bottom:0.5rem;">üõí</span>
        <div class="product-name" [innerHTML]="highlightSearch(prod.name)"></div>
        <div style="font-size:1rem;color:#888;margin-bottom:0.3rem;">Rs {{ prod.price }}</div>
        <div style="font-size:0.95rem;" [ngStyle]="{ color: prod.stock > 0 ? '#43a047' : '#888' }">Stock: {{ prod.stock }}</div>
      </div>
    </div>
    <div style="display:flex;justify-content:center;gap:0.5rem;margin-top:1rem;" *ngIf="totalPages > 1">
      <button style="background:#7b2ff2;color:#fff;border:none;border-radius:0.5rem;padding:0.4rem 1.1rem;font-size:1rem;cursor:pointer;" (click)="prevPage()" [disabled]="currentPage === 1">&lt;</button>
      <span>Page {{ currentPage }} / {{ totalPages }}</span>
      <button style="background:#7b2ff2;color:#fff;border:none;border-radius:0.5rem;padding:0.4rem 1.1rem;font-size:1rem;cursor:pointer;" (click)="nextPage()" [disabled]="currentPage === totalPages">&gt;</button>
    </div>
  </div>
</main>

<!-- Stock Update Popup -->
<div *ngIf="showStockUpdatePopup">
  <div class="stock-popup-overlay">
    <div class="stock-popup">
      <h3>Update Stock</h3>
      <div *ngIf="selectedProductForStockUpdate">
        <p>Product: <b>{{ selectedProductForStockUpdate.name }}</b></p>
        <input type="number" [(ngModel)]="selectedProductForStockUpdate.stock" min="0" />
        <button (click)="updateStock(selectedProductForStockUpdate.stock)">Update</button>
        <button (click)="closeStockMenu()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal -->
<div 
  *ngIf="showAddProduct" 
  style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;"
>
  <div style="background:#fff;padding:2rem 2.5rem;border-radius:1rem;box-shadow:0 8px 32px #0002;min-width:320px;position:relative;">
    <button 
      (click)="showAddProduct = false"
      style="position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#888;cursor:pointer;"
      aria-label="Close"
    >&times;</button>
    <h2 style="margin-top:0;color:#7b2ff2;font-weight:700;font-size:1.4rem;">Add Product</h2>
    <div style="margin-bottom:1.2rem;">
      <label style="display:block;font-weight:500;margin-bottom:0.3rem;">Product Name</label>
      <input 
        type="text" 
        [(ngModel)]="newProductName" 
        placeholder="Enter product name" 
        style="width:100%;padding:0.6rem 1rem;border-radius:0.5rem;border:1px solid #e0e0e0;"
      />
    </div>
    <div style="margin-bottom:1.2rem;">
      <label style="display:block;font-weight:500;margin-bottom:0.3rem;">Price (Rs)</label>
      <input 
        type="number" 
        [(ngModel)]="newProductPrice" 
        placeholder="Enter price" 
        style="width:100%;padding:0.6rem 1rem;border-radius:0.5rem;border:1px solid #e0e0e0;"
        min="1"
      />
    </div>
    <div style="margin-bottom:1.2rem;">
      <label style="display:block;font-weight:500;margin-bottom:0.3rem;">Stock</label>
      <input 
        type="number" 
        [(ngModel)]="newProductStock" 
        placeholder="Enter stock quantity" 
        style="width:100%;padding:0.6rem 1rem;border-radius:0.5rem;border:1px solid #e0e0e0;"
        min="0"
      />
    </div>
    <button 
      (click)="addProductToList()" 
      [disabled]="!newProductName.trim() || !newProductPrice || newProductPrice <= 0 || newProductStock == null || newProductStock < 0 || isAddingProduct"
      style="background:#7b2ff2;color:#fff;border:none;border-radius:0.5rem;padding:0.7rem 2.2rem;font-weight:600;font-size:1.1rem;cursor:pointer;"
    >
      {{ isAddingProduct ? 'Adding...' : 'Save' }}
    </button>
  </div>
</div>